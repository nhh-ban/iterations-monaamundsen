mutate(from = as_datetime(from, tz = "UTC"))
test$trafficData[[1]] |>
map(as_tibble) |>
list_rbind() |>
unnest_wider(edges) |>
unnest_wider(node) |>
mutate(from = map_chr(from, 1, .default = NA_character_)) |>
mutate(from = as_datetime(from, tz = "UTC")) |>
mutate(total = map(total, unlist)) |>
mutate(
volume = map_dbl(total, "volumeNumbers.volume")
) |>
select(-total)
test$trafficData[[1]] |>
map(as_tibble) |>
list_rbind() |>
unnest_wider(edges) |>
unnest_wider(node) |>
mutate(from = map_chr(from, 1, .default = NA_character_),
to = map_chr(to, 1, .default = NA_character_))
test$trafficData[[1]] |>
map(as_tibble) |>
list_rbind() |>
unnest_wider(edges) |>
unnest_wider(node) |>
mutate(from = map_chr(from, 1, .default = NA_character_),
to = map_chr(to, 1, .default = NA_character_)) |>
mutate(from = as_datetime(from, tz = "UTC"),
to = as_datetime(to, tz = "UTC"))
test$trafficData[[1]] |>
map(as_tibble) |>
list_rbind() |>
unnest_wider(edges) |>
unnest_wider(node) |>
mutate(from = map_chr(from, 1, .default = NA_character_),
to = map_chr(to, 1, .default = NA_character_)) |>
mutate(from = as_datetime(from, tz = "UTC"),
to = as_datetime(to, tz = "UTC")) |>
mutate(total = map(total, unlist)) |>
mutate(
volume = map_dbl(total, "volumeNumbers.volume")
) |>
select(-total)
test$trafficData[[1]] |>
map(as_tibble) |>
list_rbind() |>
unnest_wider(edges) |>
unnest_wider(node) |>
mutate(from = map_chr(from, 1, .default = NA_character_),
to = map_chr(to, 1, .default = NA_character_)) |>
mutate(from = as_datetime(from, tz = "UTC"),
to = as_datetime(to, tz = "UTC")) |>
mutate(total = map(total, unlist)) |>
mutate(
volume = map_dbl(total, "volumeNumbers.volume")
) |>
select(-total) |>
ggplot(aes(x=from, y=volume)) +
geom_line() +
theme_classic()
transform_volumes <- function(traffic_data) {
df <- traffic_data$trafficData[[1]] |>
map(as_tibble) |>
list_rbind() |>
unnest_wider(edges) |>
unnest_wider(node) |>
mutate(from = map_chr(from, 1, .default = NA_character_),
to = map_chr(to, 1, .default = NA_character_)) |>
mutate(from = as_datetime(from, tz = "UTC"),
to = as_datetime(to, tz = "UTC")) |>
mutate(total = map(total, unlist)) |>
mutate(
volume = map_dbl(total, "volumeNumbers.volume")
) |>
select(-total) |>
return(df)
}
transform_volumes <- function(traffic_data) {
df <- traffic_data$trafficData[[1]] |>
map(as_tibble) |>
list_rbind() |>
unnest_wider(edges) |>
unnest_wider(node) |>
mutate(from = map_chr(from, 1, .default = NA_character_),
to = map_chr(to, 1, .default = NA_character_)) |>
mutate(from = as_datetime(from, tz = "UTC"),
to = as_datetime(to, tz = "UTC")) |>
mutate(total = map(total, unlist)) |>
mutate(
volume = map_dbl(total, "volumeNumbers.volume")
) |>
select(-total)
return(df)
}
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
theme_classic()
library(httr)
library(jsonlite)
library(ggplot2)
library(DescTools)
library(tidyverse)
library(magrittr)
library(rlang)
library(lubridate)
library(anytime)
library(readr)
library(yaml)
library(purrr)
library(glue)
#### 1: Beginning of script
# Load function for posting GQL-queries and retrieving data:
source("functions/GQL_function.r")
# The URL we will use is stored below:
configs <-
read_yaml("vegvesen_configs.yml")
gql_metadata_qry <- read_file("gql-queries/station_metadata.gql")
# Let's try submitting the query:
stations_metadata <-
GQL(
query=gql_metadata_qry,
.url = configs$vegvesen_url
)
#### 2: Transforming metadata
source("functions/data_transformations.r")
stations_metadata_df <-
stations_metadata %>%
transform_metadata_to_df(.)
#### 3: Testing metadata
source("functions/data_tests.r")
test_stations_metadata(stations_metadata_df)
### 5: Final volume query:
source("gql-queries/vol_qry.r")
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
#Making changes so that we have appropriate legends to the plot
#The name of the traffic station
labs(x = "Time", y = "Volume", title = paste0("Volume at station ", id))
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = paste("Stasjon ID:", unique(.$id)),) +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = paste("Stasjon ID:", unique(stations_metadata_df$id)),) +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = paste("Stasjon ID:", unique(.$id))) +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = paste("Stasjon ID:", unique(vol_qry$id))) +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = "HEI") +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = paste(id)) +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = paste("id")) +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1)
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1)
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = paste(samlpe_n(1)$id)) +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = paste(sample_n(1)$id)) +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = paste(.id) +
theme_classic()
stations_metadata_df %>%
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = paste0(.id)) +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = paste0(".id")) +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = glue("Stasjon ID: {unique(.$id)}")) +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = glue("Stasjon ID: {unique(id)}")) +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = glue("Stasjon ID: {as.character(id)}")) +
theme_classic()
dataset %>%
sample_n(1) %>%  # Trekker ut en enkelt sample
pull(id) %>%    # Henter ID-en for den valgte sample
paste("Min sample har ID:", .)
stations_metadata_df %>%
sample_n(1) %>%  # Trekker ut en enkelt sample
pull(id) %>%    # Henter ID-en for den valgte sample
paste("Min sample har ID:", .)
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = paste("ID:", id)) +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = paste("ID:", id)) +
theme_classic()
stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes() %>%
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = "hei") +
theme_classic()
sample_metadata <- stations_metadata_df %>%
filter(latestData > Sys.Date() - days(7)) %>%
sample_n(1) %$%
vol_qry(
id = id,
from = to_iso8601(latestData, -4),
to = to_iso8601(latestData, 0)
) %>%
GQL(., .url = configs$vegvesen_url) %>%
transform_volumes()
View(sample_metadata)
sample_metadata <- ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = "hei") +
theme_classic()
sample_metadata |>
ggplot(aes(x=from, y=volume)) +
geom_line() +
labs(x = "Time", y = "Volume", title = "hei") +
theme_classic()
